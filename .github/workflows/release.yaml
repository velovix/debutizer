name: Do a release

on:
  workflow_call:
    inputs:
      distribution:
        description: The distribution to make a release for
        required: true
        type: string
      bucket_name:
        description: The name of the bucket to upload to
        required: true
        type: string
    secrets:
      access_key:
        required: true
      secret_key:
        required: true


jobs:
  release:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.8'
      - name: Install system dependencies
        run: sudo apt-get install pbuilder devscripts quilt debian-keyring
      - name: Install Python dependencies
        run: python -m pip install ".[dev]"
      - name: Build
        run: >
          python -m debutizer build
          --distribution ${{ inputs.distribution }}
          --package-dir tests/resources/local_upstreams
      - name: Upload
        run: >
          python -m debutizer s3-repo upload
          --endpoint https://storage.googleapis.com
          --bucket ${{ inputs.bucket_name }}
          --access-key ${{ secrets.access_key }}
          --secret-key ${{ secrets.secret_key }}